
ecosystem_vulnerability = function(ecosystem_layer,
                                   natural_lc,
                                   anthropic_lu,
                                   z = 0.25, delta = 1e-6,
                                   filename = NULL) {

  # Ecosystem codes
  eco_codes = unique(values(ecosystem_layer, mat = F, dataframe = F, na.rm = T))

  # Total current and potential natural areas of each ecosystem
  eco_areas_now = sapply(eco_codes, function(c){sum(values(natural_lc * (ecosystem_layer == c), mat = F, dataframe = F, na.rm = T))})
  eco_areas_pot = sapply(eco_codes, function(c){sum(values((anthropic_lu + natural_lc) * (ecosystem_layer == c), mat = F, dataframe = F, na.rm = T))})

  # Current ecosystem "extinction risks"
  current_ec_risk = 1. - (eco_areas_now/eco_areas_pot)^z

  # Evaluating extinction risk after a infinitesimal restoration
  derivative_ec_risk = 1. - ((eco_areas_now + delta)/eco_areas_pot)^z

  # Determining delta of ecosystem vulnerability
  delta_ec_risk = abs(derivative_ec_risk - current_ec_risk)/delta

  # Removing NAs
  delta_ec_risk[is.na(delta_ec_risk)] = 0

  # Creating reclassifying table
  reclassify = data.frame(is = eco_codes)
  reclassify$becomes = delta_ec_risk

  # Reclassifying raster
  res = classify(ecosystem_layer, rcl = reclassify)

  # Saving raster if required
  if (!is.null(filename)) {
    writeRaster(x = res, filename = filename)
  }

  # Returning result
  return(res)
}